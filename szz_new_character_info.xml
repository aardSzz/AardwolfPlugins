<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Friday, April 19, 2024, 12:00 AM -->
<!-- MuClient version 5.07-pre -->

<!-- Plugin "aard_new_character_info" generated by Plugin Wizard -->
<muclient>
<plugin
   name="szz_new_character_info"
   author="Szzilleriel"
   id="58466f80aec9a14d82f79499"
   language="Lua"
   purpose="Replace old character stats/info window"
   save_state="y"
   date_written="2024-04-18 23:59:12"
   requires="5.07"
   version="1.04"
   >
<description trim="y">
<![CDATA[
Replace old character stats/info window with a new one that contains more information.
]]>
</description>
</plugin>

<!--  Script  -->
<script>
<![CDATA[
---@diagnostic disable: undefined-global, lowercase-global
require "themed_miniwindows"
require "gmcphelper"

NewChar = "empty"
Rstring = "@RCle@G/@RMag@G/@RPal@G/@RPsi@G/@RRan@G/@RThi@G/@RWar@G"
Rdata = "empty"
local options = {
	["showname"] = true,
	["showstats"] = true,
	["showinfo"] = true,
	["showworth"] = true,
	["showremorts"] = true,
	["showclass"] = true,
	["showpups"] = true,
	["uservi"] = false,
	["userlayout"] = 0 -- 0 = Default, 1 = Tall Skinny, 2 = Long Skinny
}
local merge_task = {}

function merge_to_left(orig, new)
   merge_task[orig] = new

   local left = orig
   while left ~= nil do
      local right = merge_task[left]
      for new_key, new_val in pairs(right) do
         local old_val = left[new_key]
         if old_val == nil then
            left[new_key] = new_val
         else
            local old_type = type(old_val)
            local new_type = type(new_val)
            if (old_type == "table" and new_type == "table") then
               merge_task[old_val] = new_val
            else
               left[new_key] = new_val
            end
         end
      end
      merge_task[left] = nil
      left = next(merge_task)
   end
end

function New_Character_Info(name, line, wildcards)
	NewChar = gmcp("char")
	window_builder = "@GStr   : " .. string.format("[@W%3d@G/@W%3d@G]", NewChar.stats.str, NewChar.maxstats.maxstr) .. "    Hp    : " .. string.format("[@W%6d@G/@W%6d@G]", NewChar.vitals.hp, NewChar.maxstats.maxhp) .. "\n"
	window_builder = window_builder .. "Int   : " .. string.format("[@W%3d@G/@W%3d@G]", NewChar.stats.int, NewChar.maxstats.maxint) .. "    Ma    : " .. string.format("[@W%6d@G/@W%6d@G]", NewChar.vitals.mana, NewChar.maxstats.maxmana) .. "\n"
	window_builder = window_builder .. "Wis   : " .. string.format("[@W%3d@G/@W%3d@G]", NewChar.stats.wis, NewChar.maxstats.maxwis) .. "    Mv    : " .. string.format("[@W%6d@G/@W%6d@G]", NewChar.vitals.moves, NewChar.maxstats.maxmoves) .. "\n"
	window_builder = window_builder .. "Dex   : " .. string.format("[@W%3d@G/@W%3d@G]", NewChar.stats.dex, NewChar.maxstats.maxdex) .. "\n"
	window_builder = window_builder .. "Con   : " .. string.format("[@W%3d@G/@W%3d@G]", NewChar.stats.con, NewChar.maxstats.maxcon) .. "    HR    : " .. string.format("[@W%5d@G]", NewChar.stats.hr) .. "\n"
	window_builder = window_builder .. "Luk   : " .. string.format("[@W%3d@G/@W%3d@G]", NewChar.stats.luck, NewChar.maxstats.maxluck) .. "    DR    : " .. string.format("[@W%5d@G]", NewChar.stats.dr) .. "\n"
	window_builder = window_builder .. "\n"
	window_builder = window_builder .. "TNL   : " .. string.format("[@W%5d@G]", NewChar.status.tnl) .. "      Align : " .. string.format("[@W%5d@G]", NewChar.status.align) .. "\n"
	window_builder = window_builder .. "Train : " .. string.format("[@W%5d@G]", NewChar.worth.trains) .. "      Prac  : " .. string.format("[@W%5d@G]", NewChar.worth.pracs) .. "\n"
    window_builder = window_builder .. "\n"
	window_builder = window_builder .. "QP    : " .. string.format("[@W%6d@G]", NewChar.worth.qp) .. "     TP    : " .. string.format("[@W%5d@G]", NewChar.worth.tp) .. "\n"
	window_builder = window_builder .. "            Gold : " .. string.format("[@Y%12d@G]", NewChar.worth.gold) .. "\n"
	window_builder = window_builder .. "\n"
	window_builder = window_builder .. "                   Remorts\n"
	-- Do not hammer cpus with gsub replacements except when needed
	if not string.find(Rdata, NewChar.base.classes) then
		Rdata = NewChar.base.classes
		processremorts()
	end
	window_builder = window_builder .. "         " .. Rstring .. "\n"
	window_builder = window_builder .. "\n"
	window_builder = window_builder .. "Pri   : " .. string.format("[@W%10s@G]", NewChar.base.class) .. "  Sub    : " .. string.format("[@W%12s@G]", NewChar.base.subclass) .. "\n"
	window_builder = window_builder .. "Pup   : " .. string.format("[@W%10d@G]", NewChar.base.pups) .. "  Totpup : " .. string.format("[@W%12d@G]", NewChar.base.totpups)
    draw_window(window_builder)
	window:dress_window("@R" .. NewChar.base.pretitle .. NewChar.base.name .. "@G\n Level:@W " .. NewChar.base.level .. "@G [@WT+" .. NewChar.base.tier .. "@G/@WR+" .. string.len(NewChar.base.classes) .. "@G]")
end

function processremorts()
	if string.find(Rdata, "0") then
		Rstring = string.gsub(Rstring, "@RMag", "@GMag")
	else
		Rstring = string.gsub(Rstring, "@GMag", "@RMag")
	end
	if string.find(Rdata, "1") then
		Rstring = string.gsub(Rstring, "@RCle", "@GCle")
	else
		Rstring = string.gsub(Rstring, "@GCle", "@RCle")
	end
	if string.find(Rdata, "2") then
		Rstring = string.gsub(Rstring, "@RThi", "@GThi")
	else
		Rstring = string.gsub(Rstring, "@GThi", "@RThi")
	end
	if string.find(Rdata, "3") then
		Rstring = string.gsub(Rstring, "@RWar", "@GWar")
	else
		Rstring = string.gsub(Rstring, "@GWar", "@RWar")
	end
	if string.find(Rdata, "4") then
		Rstring = string.gsub(Rstring, "@RRan", "@GRan")
	else
		Rstring = string.gsub(Rstring, "@GRan", "@RRan")
	end
	if string.find(Rdata, "5") then
		Rstring = string.gsub(Rstring, "@RPal", "@GPal")
	else
		Rstring = string.gsub(Rstring, "@GPal", "@RPal")
	end
	if string.find(Rdata, "6") then
		Rstring = string.gsub(Rstring, "@RPsi", "@GPsi")
	else
		Rstring = string.gsub(Rstring, "@GPsi", "@RPsi")
	end
end

function OnPluginBroadcast (msg, id, name, text)
    if (id == '3e7dedbe37e44942dd46d264') then
		if (text == "char.base") then
			local cbase = gmcp("char.base")
			merge_to_left(NewChar, cbase)
		end
		if (text == "char.maxstats") then
			local maxstats = gmcp("char.maxstats")
			merge_to_left(NewChar, maxstats)
		end
		if (text == "char.stats") then
			local cstats = gmcp("char.stats")
			merge_to_left(NewChar, cstats)
		end
		if (text == "char.status") then
			local cstatus = gmcp("char.status")
			merge_to_left(NewChar, cstatus)
		end
		if (text == "char.vitals") then
			local vstats = gmcp("char.vitals")
			merge_to_left(NewChar, vstats)
		end
		if (text == "char.worth") then
			local worth = gmcp("char.worth")
			merge_to_left(NewChar, worth)
		end
		New_Character_Info()
    end
 end

 function OnPluginEnable()
	New_Character_Info()
end

function OnPluginInstall()
	New_Character_Info()
	ColourNote("white", "", "[aard_new_character_info] Installed v" .. GetPluginInfo(GetPluginID(), 19) .. "b")
end

function OnPluginDisable()
	if window then
		window:delete()
		window = nil
	end
end

function OnPluginClose()
	if window then
		window:delete()
		window = nil
	end
end

function draw_window(string)
	if not window then
		window = ThemedTextWindow(
			"58466f80aec9a14d82f79499",                    -- string, required, a unique identifier for this window
			0, -- integer, required, where to put it if the player hasn't moved it
			0,  -- integer, required, where to put it if the player hasn't moved it
			330,         -- integer, required, how big to make it if the player hasn't moved it
			295,        -- integer, required, how big to make it if the player hasn't moved it
			"@R" .. NewChar.base.pretitle .. NewChar.base.name .. "@G\n Level:@W " .. NewChar.base.level .. "@G [@WT+" .. NewChar.base.tier .. "@G/@WR+" .. string.len(NewChar.base.classes) .. "@G]",                 -- string, optional (nil means no titlebar), text to put into the title
			nil,       -- string, optional (default is "center"), "left", "center", or "right"
			false,          -- boolean, optional (default is false), true adds a close button in the top left
			true,            -- boolean, optional (default is false), make the window resizeable
			false,       -- boolean, optional (default is false), add a scrollbar and mousewheel scrolling
			true,       -- boolean, optional (default is false), make the text selectable
			true,         -- boolean, optional (default is false), make the text copyable via right-click
			false,        -- boolean, optional (default is false), turn detected URLs into clickable links
			true,              -- boolean, optional (default is false), automatically wrap text lines that are too wide
			"Dina",       -- string, optional (default is Dina), override the title font name
			8,       -- integer, optional (default is 10), override the title font size
			"Dina",        -- string, optional (default is Dina), override the body text font name
			8,        -- integer, optional (default is 10), override the body text font size
			nil,        -- integer, optional (default is 1000), maximum number of text lines to keep
			5           -- integer, optional (default is 5 pixels), space between text and miniwindow frame
		)
	end

	window:clear(false)
	window:add_text(string, true)
end
]]>
</script>

<!--  Plugin help  -->
<aliases>
  <alias
   script="OnHelp"
   match="aard_new_character_info:help"
   enabled="y"
  >
  </alias>
</aliases>

<script>
<![CDATA[
function OnHelp ()
  world.Note (world.GetPluginInfo (world.GetPluginID (), 3))
end
]]>
</script> 

</muclient>
